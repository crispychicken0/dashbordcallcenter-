from pathlib import Path
import pandas as pd
import json, datetime, os
import io

# Load the Excel file with the new data structure
file_path = "/mnt/data/Orders Detail Track (6).xlsx"
df = pd.read_excel(file_path, sheet_name="Orders Detail Track")

# Clean and prepare data for JSON export
# Map the new column structure
columns_map = {
    "TIME ORDER": "order_time",
    "Date": "date",
    "Order no": "order_no",
    "PHONE NO.": "phone",
    "NAME": "customer_name",
    "BRANCH": "branch",
    "AMOUNT": "amount",
    "TYPE": "order_type",
    "AGENT NAME": "agent_name",
    "AREA": "area",
    "VOID": "is_void",
    "REASON OF VOID": "void_reason"
}

# Filter out rows with #VALUE! in the Order no column
df = df[df['Order no'] != '#VALUE!']

# Select available columns and rename
available_cols = [c for c in df.columns if c in columns_map]
df_small = df[available_cols].rename(columns=columns_map)

# Convert datelike strings to readable format
def try_parse_date(x):
    try:
        return pd.to_datetime(x).isoformat()
    except Exception:
        return str(x)

df_small['date'] = df_small['date'].apply(try_parse_date)
df_small['order_time'] = df_small['order_time'].apply(try_parse_date)

# Fill NaNs for JSON cleanliness
df_small = df_small.fillna("")

# Add delivery time calculation (assuming it's in minutes)
df_small['delivery_time'] = ""  # This field is not in the provided data

# Compute metrics
total_orders = len(df_small)
total_value = df_small['amount'].replace('', 0).astype(float).sum()
void_count = df_small['is_void'].apply(lambda x: x.lower() == 'yes' if isinstance(x, str) else False).sum()
void_pct = round((void_count/total_orders)*100,2) if total_orders>0 else 0.0

# Group by branch and agent
by_branch = df_small.groupby('branch').agg(
    orders=('order_no','count'), 
    value=('amount', 'sum')
).reset_index().to_dict(orient='records')

by_agent = df_small.groupby('agent_name').agg(
    orders=('order_no','count'), 
    value=('amount','sum')
).reset_index().to_dict(orient='records')

# Group by order type
by_type = df_small.groupby('order_type').agg(
    orders=('order_no','count'), 
    value=('amount', 'sum')
).reset_index().to_dict(orient='records')

# Prepare JSON data
data = {
    "generated_at": datetime.datetime.utcnow().isoformat() + "Z",
    "total_orders": int(total_orders),
    "total_value": float(total_value),
    "void_count": int(void_count),
    "void_pct": float(void_pct),
    "by_branch": by_branch,
    "by_agent": by_agent,
    "by_type": by_type,
    "orders": df_small.to_dict(orient='records'),
    "branches": list(df_small['branch'].unique()),
    "agents": list(df_small['agent_name'].unique()),
    "order_types": list(df_small['order_type'].unique()),
    "min_date": df_small['date'].min(),
    "max_date": df_small['date'].max()
}

# Create HTML dashboard with system dock
html_template = """<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Crispy Chicken — Order Management Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
<style>
:root{ --bg:#0b0f14; --muted:#98a0a6; --accent:#7a5aff; --glass:rgba(255,255,255,0.04); --dock:#0d1117; --dock-hover:#161b22 }
body{background:linear-gradient(180deg,#071019,#0b0f14);color:#e9eef3;font-family:Inter,system-ui,Arial;padding:0;margin:0}
.glass{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.04);backdrop-filter:blur(8px);border-radius:12px;padding:16px}
.metric-value{font-size:1.6rem;font-weight:700;background:linear-gradient(90deg,#7a5aff,#5ef3c8);-webkit-background-clip:text;color:transparent}
.table-fixed tbody{max-height:360px;overflow:auto;display:block}
.table-fixed thead, .table-fixed tbody tr {display:table;width:100%;table-layout:fixed}
.table-fixed thead {width:100%}
.badge-status{padding:.35rem .6rem;border-radius:999px;font-weight:700}
.badge-active{background:rgba(122,90,255,0.12);color:#dcdfff}
.badge-late{background:rgba(255,107,107,0.12);color:#ffd6d6}
.badge-void{background:rgba(255,165,0,0.12);color:#ffe0b3}
.filter-pill{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.02);cursor:pointer;margin-right:8px}
.filter-pill.active{background:linear-gradient(90deg,#7a5aff,#5ef3c8);color:#041018}
/* System Dock */
.dock{position:fixed;bottom:0;left:0;width:100%;height:60px;background:var(--dock);border-top:1px solid rgba(255,255,255,0.1);display:flex;align-items:center;justify-content:center;gap:15px;z-index:1000}
.dock-item{width:45px;height:45px;border-radius:8px;background:var(--dock-hover);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all 0.2s}
.dock-item:hover{background:var(--accent);transform:scale(1.1)}
.dock-item.active{background:var(--accent)}
.dock-item i{font-size:1.2rem;color:#e9eef3}
/* Sidebar */
.sidebar{position:fixed;top:0;left:0;width:300px;height:100%;background:var(--dock);z-index:999;transform:translateX(-100%);transition:transform 0.3s;overflow-y:auto}
.sidebar.active{transform:translateX(0)}
.sidebar-header{padding:20px;border-bottom:1px solid rgba(255,255,255,0.1);display:flex;align-items:center;justify-content:space-between}
.sidebar-content{padding:20px}
/* Main Content */
.main-content{padding:20px;padding-bottom:100px}
/* Filters */
.filter-group{margin-bottom:20px}
.filter-group label{display:block;margin-bottom:5px;color:#98a0a6;font-size:0.9rem}
.filter-group select, .filter-group input{width:100%;padding:8px 12px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:#e9eef3}
/* Export Buttons */
.export-btn{width:100%;margin-bottom:10px;display:flex;align-items:center;gap:8px;justify-content:center;padding:10px;border-radius:6px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);color:#e9eef3;cursor:pointer;transition:all 0.2s}
.export-btn:hover{background:rgba(122,90,255,0.2);border-color:var(--accent)}
/* Date Range Picker */
.date-range{display:flex;gap:10px}
.date-range input{flex:1}
/* Notification */
.notification{position:fixed;bottom:80px;right:20px;padding:15px 20px;background:rgba(122,90,255,0.9);color:white;border-radius:8px;transform:translateY(100px);transition:transform 0.3s;z-index:1001}
.notification.show{transform:translateY(0)}
</style>
</head>
<body>
<!-- System Dock -->
<div class="dock">
  <div class="dock-item active" id="dashboardBtn" title="Dashboard">
    <i class="bi bi-speedometer2"></i>
  </div>
  <div class="dock-item" id="filtersBtn" title="Filters">
    <i class="bi bi-funnel"></i>
  </div>
  <div class="dock-item" id="exportBtn" title="Export">
    <i class="bi bi-download"></i>
  </div>
  <div class="dock-item" id="refreshBtn" title="Refresh Data">
    <i class="bi bi-arrow-clockwise"></i>
  </div>
  <div class="dock-item" id="settingsBtn" title="Settings">
    <i class="bi bi-gear"></i>
  </div>
</div>

<!-- Sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <h5>Dashboard Controls</h5>
    <button class="btn btn-sm btn-link text-light" id="closeSidebar">
      <i class="bi bi-x-lg"></i>
    </button>
  </div>
  <div class="sidebar-content">
    <!-- Date Range Filter -->
    <div class="filter-group">
      <label>Date Range</label>
      <div class="date-range">
        <input type="date" id="startDate" />
        <input type="date" id="endDate" />
      </div>
    </div>
    
    <!-- Branch Filter -->
    <div class="filter-group">
      <label>Branch</label>
      <select id="branchFilter">
        <option value="">All Branches</option>
        __BRANCH_OPTIONS__
      </select>
    </div>
    
    <!-- Agent Filter -->
    <div class="filter-group">
      <label>Agent</label>
      <select id="agentFilter">
        <option value="">All Agents</option>
        __AGENT_OPTIONS__
      </select>
    </div>
    
    <!-- Order Type Filter -->
    <div class="filter-group">
      <label>Order Type</label>
      <select id="typeFilter">
        <option value="">All Types</option>
        __TYPE_OPTIONS__
      </select>
    </div>
    
    <!-- Void Orders Filter -->
    <div class="filter-group">
      <label>Void Orders</label>
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="voidCheck">
        <label class="form-check-label" for="voidCheck">Show Only Void Orders</label>
      </div>
    </div>
    
    <!-- Export Options -->
    <h6 class="mt-4 mb-3">Export Options</h6>
    <div class="export-btn" id="exportCSV">
      <i class="bi bi-filetype-csv"></i> Export to CSV
    </div>
    <div class="export-btn" id="exportExcel">
      <i class="bi bi-filetype-excel"></i> Export to Excel
    </div>
    <div class="export-btn" id="exportPDF">
      <i class="bi bi-filetype-pdf"></i> Export to PDF
    </div>
    
    <!-- Reset Filters -->
    <div class="export-btn" id="resetFilters">
      <i class="bi bi-arrow-counterclockwise"></i> Reset All Filters
    </div>
  </div>
</div>

<!-- Main Dashboard Content -->
<div class="main-content">
  <div class="d-flex align-items-center gap-3 mb-3">
    <button class="btn btn-sm btn-outline-light d-md-none" id="mobileMenuBtn">
      <i class="bi bi-list"></i>
    </button>
    <h3>Crispy Chicken — Order Management Dashboard</h3>
    <small class="text-muted">Loaded from Excel: Orders Detail Track (6).xlsx</small>
    <div class="ms-auto d-none d-md-flex">
      <button class="btn btn-sm btn-outline-light" id="refreshDataBtn">
        <i class="bi bi-arrow-clockwise"></i> Refresh
      </button>
    </div>
  </div>
  
  <div class="row g-3 mb-3">
    <div class="col-md-3">
      <div class="glass">
        <div class="text-muted">Total Orders</div>
        <div id="metricTotal" class="metric-value">-</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="glass">
        <div class="text-muted">Total Value (AED)</div>
        <div id="metricValue" class="metric-value">-</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="glass">
        <div class="text-muted">Void Orders</div>
        <div id="metricVoid" class="metric-value">-</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="glass">
        <div class="text-muted">Void %</div>
        <div id="metricVoidPct" class="metric-value">-</div>
      </div>
    </div>
  </div>
  
  <div class="glass mb-3">
    <div class="d-flex align-items-center gap-2 mb-2">
      <input id="search" class="form-control form-control-sm" style="max-width:360px" placeholder="Search order no, customer, branch, agent..." />
      <div class="ms-2">
        <span class="filter-pill active" data-filter="all">All</span>
        <span class="filter-pill" data-filter="delivery">Delivery</span>
        <span class="filter-pill" data-filter="pickup">Pickup</span>
        <span class="filter-pill" data-filter="void">Void</span>
      </div>
      <div class="ms-auto text-muted">Generated at: <span id="generatedAt"></span></div>
    </div>
    
    <div class="table-responsive">
      <table class="table table-borderless align-middle" id="ordersTable">
        <thead>
          <tr class="text-muted small">
            <th style="width:120px">Order no</th>
            <th style="width:140px">Date</th>
            <th>Branch</th>
            <th>Customer</th>
            <th style="width:120px">Agent</th>
            <th style="width:90px">Type</th>
            <th style="width:110px">Amount</th>
            <th style="width:110px">Area</th>
            <th style="width:120px">Status</th>
          </tr>
        </thead>
        <tbody id="ordersTbody"></tbody>
      </table>
    </div>
  </div>
  
  <div class="row g-3">
    <div class="col-md-4">
      <div class="glass">
        <h6>Orders by Branch</h6>
        <div id="byBranch"></div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="glass">
        <h6>Orders by Agent</h6>
        <div id="byAgent"></div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="glass">
        <h6>Orders by Type</h6>
        <div id="byType"></div>
      </div>
    </div>
  </div>
</div>

<!-- Notification -->
<div class="notification" id="notification"></div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
<script>
// Embedded data (from Excel)
const DATA = __DATA_JSON__;
const ORIGINAL_DATA = JSON.parse(JSON.stringify(DATA));

// Format currency
function formatCurrency(v){ 
  return Number(v||0).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}); 
}

// Show notification
function showNotification(message, duration = 3000) {
  const notification = document.getElementById('notification');
  notification.textContent = message;
  notification.classList.add('show');
  setTimeout(() => {
    notification.classList.remove('show');
  }, duration);
}

// Render metrics
function renderMetrics(){
  document.getElementById('metricTotal').textContent = DATA.total_orders;
  document.getElementById('metricValue').textContent = formatCurrency(DATA.total_value);
  document.getElementById('metricVoid').textContent = DATA.void_count;
  document.getElementById('metricVoidPct').textContent = DATA.void_pct + '%';
  document.getElementById('generatedAt').textContent = DATA.generated_at;
}

// Status badge
function statusBadge(order){
  if(order.is_void && order.is_void.toLowerCase() === 'yes') {
    return '<span class="badge-status badge-void">Void</span>';
  }
  return '<span class="badge-status badge-active">OK</span>';
}

// Render table
function renderTable(rows){
  const tbody = document.getElementById('ordersTbody');
  tbody.innerHTML = '';
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.order_no}</td>
      <td>${r.date}</td>
      <td>${r.branch}</td>
      <td>${r.customer_name}</td>
      <td>${r.agent_name}</td>
      <td>${r.order_type}</td>
      <td>${formatCurrency(r.amount)}</td>
      <td>${r.area}</td>
      <td>${statusBadge(r)}</td>
    `;
    tbody.appendChild(tr);
  });
}

// Render by branch
function renderByBranch(){
  const container = document.getElementById('byBranch');
  container.innerHTML = '';
  DATA.by_branch.forEach(b=>{
    const el = document.createElement('div');
    el.className='d-flex justify-content-between py-1 border-bottom';
    el.innerHTML = `<div class="text-muted">${b.branch}</div><div><strong>${b.orders}</strong> • AED ${formatCurrency(b.value)}</div>`;
    container.appendChild(el);
  });
}

// Render by agent
function renderByAgent(){
  const container = document.getElementById('byAgent');
  container.innerHTML = '';
  DATA.by_agent.forEach(a=>{
    const el = document.createElement('div');
    el.className='d-flex justify-content-between py-1 border-bottom';
    el.innerHTML = `<div class="text-muted">${a.agent_name}</div><div><strong>${a.orders}</strong> • AED ${formatCurrency(a.value)}</div>`;
    container.appendChild(el);
  });
}

// Render by type
function renderByType(){
  const container = document.getElementById('byType');
  container.innerHTML = '';
  DATA.by_type.forEach(t=>{
    const el = document.createElement('div');
    el.className='d-flex justify-content-between py-1 border-bottom';
    el.innerHTML = `<div class="text-muted">${t.order_type}</div><div><strong>${t.orders}</strong> • AED ${formatCurrency(t.value)}</div>`;
    container.appendChild(el);
  });
}

// Apply filters
function applyFilters(){
  const searchTerm = document.getElementById('search').value.toLowerCase().trim();
  const activeFilter = Array.from(document.querySelectorAll('.filter-pill.active')).map(x=>x.dataset.filter)[0] || 'all';
  const startDate = document.getElementById('startDate').value;
  const endDate = document.getElementById('endDate').value;
  const branch = document.getElementById('branchFilter').value;
  const agent = document.getElementById('agentFilter').value;
  const type = document.getElementById('typeFilter').value;
  const voidChecked = document.getElementById('voidCheck').checked;
  
  let rows = ORIGINAL_DATA.orders.slice();
  
  // Search filter
  if(searchTerm) {
    rows = rows.filter(r=> JSON.stringify(r).toLowerCase().includes(searchTerm));
  }
  
  // Type filters
  if(activeFilter === 'delivery') rows = rows.filter(r=>r.order_type && r.order_type.toLowerCase().includes('delivery'));
  if(activeFilter === 'pickup') rows = rows.filter(r=>r.order_type && r.order_type.toLowerCase().includes('pickup'));
  if(activeFilter === 'void') rows = rows.filter(r=> r.is_void && r.is_void.toLowerCase() === 'yes' );
  
  // Date range filter
  if(startDate) {
    rows = rows.filter(r => r.date >= startDate);
  }
  if(endDate) {
    rows = rows.filter(r => r.date <= endDate);
  }
  
  // Branch filter
  if(branch) {
    rows = rows.filter(r => r.branch === branch);
  }
  
  // Agent filter
  if(agent) {
    rows = rows.filter(r => r.agent_name === agent);
  }
  
  // Order type filter
  if(type) {
    rows = rows.filter(r => r.order_type === type);
  }
  
  // Void orders filter
  if(voidChecked) {
    rows = rows.filter(r => r.is_void && r.is_void.toLowerCase() === 'yes');
  }
  
  // Update metrics based on filtered data
  DATA.total_orders = rows.length;
  DATA.total_value = rows.reduce((sum, r) => sum + (parseFloat(r.amount) || 0), 0);
  DATA.void_count = rows.filter(r => r.is_void && r.is_void.toLowerCase() === 'yes').length;
  DATA.void_pct = rows.length > 0 ? round((DATA.void_count / rows.length) * 100, 2) : 0;
  
  renderMetrics();
  renderTable(rows);
}

// Round function
function round(value, decimals) {
  return Number(Math.round(value + 'e' + decimals) + 'e-' + decimals);
}

// Export to CSV
function exportToCSV() {
  const rows = document.getElementById('ordersTbody').querySelectorAll('tr');
  let csv = 'Order No,Date,Branch,Customer,Agent,Type,Amount,Area,Status\\n';
  
  rows.forEach(tr => {
    const tds = tr.querySelectorAll('td');
    const row = [
      tds[0].textContent,
      tds[1].textContent,
      tds[2].textContent,
      tds[3].textContent,
      tds[4].textContent,
      tds[5].textContent,
      tds[6].textContent,
      tds[7].textContent,
      tds[8].textContent.trim()
    ];
    csv += row.map(cell => `"${cell}"`).join(',') + '\\n';
  });
  
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  link.setAttribute('href', url);
  link.setAttribute('download', `orders_export_${new Date().toISOString().slice(0,10)}.csv`);
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  showNotification('CSV export successful!');
}

// Export to Excel
function exportToExcel() {
  // Create a simple Excel-like table using HTML
  const table = document.getElementById('ordersTable');
  const html = table.outerHTML;
  
  const blob = new Blob([html], { type: 'application/vnd.ms-excel' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `orders_export_${new Date().toISOString().slice(0,10)}.xls`;
  link.click();
  showNotification('Excel export successful!');
}

// Export to PDF
function exportToPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  
  // Add title
  doc.setFontSize(18);
  doc.text('Crispy Chicken Orders Report', 14, 15);
  
  // Add date
  doc.setFontSize(10);
  doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 25);
  
  // Add table
  const tableRows = document.querySelectorAll('#ordersTable tbody tr');
  const tableData = Array.from(tableRows).map(tr => {
    return Array.from(tr.querySelectorAll('td')).map(td => td.textContent.trim());
  });
  
  doc.autoTable({
    head: [['Order No', 'Date', 'Branch', 'Customer', 'Agent', 'Type', 'Amount', 'Area', 'Status']],
    body: tableData,
    startY: 30,
    theme: 'grid',
    styles: { fontSize: 8 },
    headStyles: { fillColor: [122, 90, 255] }
  });
  
  doc.save(`orders_report_${new Date().toISOString().slice(0,10)}.pdf`);
  showNotification('PDF export successful!');
}

// Reset all filters
function resetFilters() {
  document.getElementById('search').value = '';
  document.getElementById('startDate').value = '';
  document.getElementById('endDate').value = '';
  document.getElementById('branchFilter').value = '';
  document.getElementById('agentFilter').value = '';
  document.getElementById('typeFilter').value = '';
  document.getElementById('voidCheck').checked = false;
  
  // Reset filter pills
  document.querySelectorAll('.filter-pill').forEach(p => p.classList.remove('active'));
  document.querySelector('.filter-pill[data-filter="all"]').classList.add('active');
  
  // Reset data to original
  DATA.total_orders = ORIGINAL_DATA.total_orders;
  DATA.total_value = ORIGINAL_DATA.total_value;
  DATA.void_count = ORIGINAL_DATA.void_count;
  DATA.void_pct = ORIGINAL_DATA.void_pct;
  
  renderMetrics();
  renderTable(ORIGINAL_DATA.orders);
  renderByBranch();
  renderByAgent();
  renderByType();
  showNotification('Filters reset successfully!');
}

// Event Listeners
document.addEventListener('DOMContentLoaded', function() {
  // Set date range
  document.getElementById('startDate').value = DATA.min_date.slice(0,10);
  document.getElementById('endDate').value = DATA.max_date.slice(0,10);
  
  // Initialize dashboard
  renderMetrics();
  renderTable(DATA.orders);
  renderByBranch();
  renderByAgent();
  renderByType();
  
  // Dock item clicks
  document.getElementById('dashboardBtn').addEventListener('click', function() {
    this.classList.add('active');
    document.getElementById('filtersBtn').classList.remove('active');
    document.getElementById('exportBtn').classList.remove('active');
    document.getElementById('settingsBtn').classList.remove('active');
  });
  
  document.getElementById('filtersBtn').addEventListener('click', function() {
    this.classList.add('active');
    document.getElementById('sidebar').classList.add('active');
    document.getElementById('dashboardBtn').classList.remove('active');
    document.getElementById('exportBtn').classList.remove('active');
    document.getElementById('settingsBtn').classList.remove('active');
  });
  
  document.getElementById('exportBtn').addEventListener('click', function() {
    this.classList.add('active');
    document.getElementById('sidebar').classList.add('active');
    document.getElementById('dashboardBtn').classList.remove('active');
    document.getElementById('filtersBtn').classList.remove('active');
    document.getElementById('settingsBtn').classList.remove('active');
  });
  
  document.getElementById('settingsBtn').addEventListener('click', function() {
    this.classList.add('active');
    document.getElementById('dashboardBtn').classList.remove('active');
    document.getElementById('filtersBtn').classList.remove('active');
    document.getElementById('exportBtn').classList.remove('active');
  });
  
  // Sidebar controls
  document.getElementById('closeSidebar').addEventListener('click', function() {
    document.getElementById('sidebar').classList.remove('active');
  });
  
  document.getElementById('mobileMenuBtn').addEventListener('click', function() {
    document.getElementById('sidebar').classList.add('active');
  });
  
  // Filter controls
  document.getElementById('search').addEventListener('input', applyFilters);
  document.getElementById('startDate').addEventListener('change', applyFilters);
  document.getElementById('endDate').addEventListener('change', applyFilters);
  document.getElementById('branchFilter').addEventListener('change', applyFilters);
  document.getElementById('agentFilter').addEventListener('change', applyFilters);
  document.getElementById('typeFilter').addEventListener('change', applyFilters);
  document.getElementById('voidCheck').addEventListener('change', applyFilters);
  
  // Filter pills
  document.querySelectorAll('.filter-pill').forEach(pill => {
    pill.addEventListener('click', function() {
      document.querySelectorAll('.filter-pill').forEach(p => p.classList.remove('active'));
      this.classList.add('active');
      applyFilters();
    });
  });
  
  // Export buttons
  document.getElementById('exportCSV').addEventListener('click', exportToCSV);
  document.getElementById('exportExcel').addEventListener('click', exportToExcel);
  document.getElementById('exportPDF').addEventListener('click', exportToPDF);
  
  // Reset button
  document.getElementById('resetFilters').addEventListener('click', resetFilters);
  
  // Refresh button
  document.getElementById('refreshDataBtn').addEventListener('click', function() {
    resetFilters();
    showNotification('Data refreshed!');
  });
  
  // Dock refresh button
  document.getElementById('refreshBtn').addEventListener('click', function() {
    resetFilters();
    showNotification('Data refreshed!');
  });
});
</script>
</body>
</html>
"""

# Prepare options for dropdowns
branch_options = "\n".join([f'<option value="{branch}">{branch}</option>' for branch in data['branches']])
agent_options = "\n".join([f'<option value="{agent}">{agent}</option>' for agent in data['agents']])
type_options = "\n".join([f'<option value="{order_type}">{order_type}</option>' for order_type in data['order_types']])

# Replace placeholders in template
html_content = html_template.replace("__BRANCH_OPTIONS__", branch_options)
html_content = html_content.replace("__AGENT_OPTIONS__", agent_options)
html_content = html_content.replace("__TYPE_OPTIONS__", type_options)
html_content = html_content.replace("__DATA_JSON__", json.dumps(data))

# Write to file
out_path = Path("/mnt/data/order_management_dashboard.html")
out_path.write_text(html_content, encoding="utf-8")

print(f"Order Management Dashboard created successfully: {str(out_path)}")
