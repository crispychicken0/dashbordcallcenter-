import sqlite3
from datetime import datetime, timedelta
import threading
import time
from flask import Flask, render_template_string, request, jsonify
from flask_sqlalchemy import SQLAlchemy
import os

# إعداد التطبيق
app = Flask(__name__)
app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///delivery_system.db'
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False
db = SQLAlchemy(app)

# تعريف نماذج قاعدة البيانات
class Order(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    order_no = db.Column(db.String(50), unique=True)
    pos_order_no = db.Column(db.String(50))
    date = db.Column(db.Date)
    outlet = db.Column(db.String(50))
    cus_name = db.Column(db.String(100))
    cus_phone = db.Column(db.String(20))
    address = db.Column(db.Text)
    pay_method = db.Column(db.String(20))
    order_total = db.Column(db.Float)
    discount = db.Column(db.Float)
    order_with_vat = db.Column(db.Float)
    delivery_fee = db.Column(db.Float)
    final_total = db.Column(db.Float)
    agent_name = db.Column(db.String(50))
    ordered_items = db.Column(db.Text)
    customer_comments = db.Column(db.Text)
    recieve_time = db.Column(db.DateTime)
    prep_time = db.Column(db.Integer)
    dispatch_time = db.Column(db.DateTime)
    delivery_time = db.Column(db.DateTime)
    type = db.Column(db.String(20))
    expected_delivery_time = db.Column(db.DateTime)
    delay_minutes = db.Column(db.Integer, default=0)
    status = db.Column(db.String(20), default='preparing')
    last_updated = db.Column(db.DateTime, default=datetime.utcnow)

class Incident(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    order_no = db.Column(db.String(50))
    incident_description = db.Column(db.Text)
    incident_comments = db.Column(db.Text)
    resolved = db.Column(db.Boolean, default=False)
    resolve_by_agent = db.Column(db.String(50))
    resolve_time = db.Column(db.DateTime)

class Branch(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    outlet_name = db.Column(db.String(50), unique=True)
    location = db.Column(db.String(100))
    manager = db.Column(db.String(50))
    avg_delivery_time = db.Column(db.Integer, default=0)

class Agent(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    agent_name = db.Column(db.String(50), unique=True)
    outlet_id = db.Column(db.Integer)
    performance_score = db.Column(db.Integer, default=100)
    total_orders = db.Column(db.Integer, default=0)
    resolved_incidents = db.Column(db.Integer, default=0)

# إنشاء قاعدة البيانات
def init_db():
    with app.app_context():
        db.create_all()
        # إضافة بيانات افتراضية
        if not Branch.query.first():
            branches = [
                Branch(outlet_name="فرع الرياض", location="الرياض", manager="أحمد علي"),
                Branch(outlet_name="فرع جدة", location="جدة", manager="فاطمة محمد")
            ]
            db.session.add_all(branches)
            
            agents = [
                Agent(agent_name="محمد سعود", outlet_id=1),
                Agent(agent_name="نورا خالد", outlet_id=2)
            ]
            db.session.add_all(agents)
            db.session.commit()

# وظيفة خلفية لتحديث التأخيرات
def update_delays():
    while True:
        with app.app_context():
            now = datetime.utcnow()
            orders = Order.query.filter(
                Order.status != 'delivered',
                Order.expected_delivery_time < now
            ).all()
            
            for order in orders:
                delay = int((now - order.expected_delivery_time).total_seconds() / 60)
                order.delay_minutes = delay
                if delay > 15:
                    order.status = 'delayed'
                db.session.commit()
        
        time.sleep(300)  # تحديث كل 5 دقائق

# بدء خلفية التحديث
delay_thread = threading.Thread(target=update_delays, daemon=True)
delay_thread.start()

# واجهات API
@app.route('/')
def dashboard():
    return render_template_string(DASHBOARD_HTML)

@app.route('/api/delayed-orders')
def get_delayed_orders():
    outlet = request.args.get('outlet')
    agent = request.args.get('agent')
    status = request.args.get('status', 'delayed')
    
    query = Order.query.filter_by(status=status)
    if outlet:
        query = query.filter_by(outlet=outlet)
    if agent:
        query = query.filter_by(agent_name=agent)
    
    orders = query.all()
    return jsonify([{
        'id': o.id,
        'order_no': o.order_no,
        'outlet': o.outlet,
        'agent_name': o.agent_name,
        'delay_minutes': o.delay_minutes,
        'cus_name': o.cus_name,
        'status': o.status,
        'last_updated': o.last_updated.isoformat()
    } for o in orders])

@app.route('/api/update-order/<int:order_id>', methods=['POST'])
def update_order(order_id):
    order = Order.query.get(order_id)
    data = request.json
    order.status = data.get('status', order.status)
    order.delay_minutes = data.get('delay_minutes', order.delay_minutes)
    order.last_updated = datetime.utcnow()
    db.session.commit()
    return jsonify({'message': 'Order updated successfully'})

@app.route('/api/contact-customer/<int:order_id>', methods=['POST'])
def contact_customer(order_id):
    order = Order.query.get(order_id)
    # هنا يمكن إضافة منطق الاتصال بالعميل
    incident = Incident(
        order_no=order.order_no,
        incident_description=f"Contacted customer for delayed order {order.order_no}",
        resolve_by_agent=order.agent_name,
        resolve_time=datetime.utcnow(),
        resolved=True
    )
    db.session.add(incident)
    db.session.commit()
    return jsonify({'message': f'Customer contacted: {order.cus_phone}'})

@app.route('/api/branch-performance')
def branch_performance():
    branches = Branch.query.all()
    return jsonify([{
        'outlet_name': b.outlet_name,
        'avg_delivery_time': b.avg_delivery_time,
        'total_agents': Agent.query.filter_by(outlet_id=b.id).count()
    } for b in branches])

@app.route('/api/agent-performance')
def agent_performance():
    agents = Agent.query.all()
    return jsonify([{
        'agent_name': a.agent_name,
        'performance_score': a.performance_score,
        'resolved_incidents': a.resolved_incidents
    } for a in agents])

# HTML Template
DASHBOARD_HTML = '''
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة التحكم - نظام التوصيل</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .delay-high { color: #dc3545; font-weight: bold; }
        .delay-medium { color: #fd7e14; }
        .delay-low { color: #198754; }
        .card { margin-bottom: 20px; }
        .table th { text-align: center; }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <h1 class="mb-4">لوحة التحكم - نظام التوصيل</h1>
        
        <!-- الفلاتر -->
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label for="outlet" class="form-label">الفرع</label>
                        <select id="outlet" class="form-select">
                            <option value="">الكل</option>
                            <option value="فرع الرياض">فرع الرياض</option>
                            <option value="فرع جدة">فرع جدة</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="agent" class="form-label">الوكيل</label>
                        <select id="agent" class="form-select">
                            <option value="">الكل</option>
                            <option value="محمد سعود">محمد سعود</option>
                            <option value="نورا خالد">نورا خالد</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="status" class="form-label">الحالة</label>
                        <select id="status" class="form-select">
                            <option value="delayed">متأخر</option>
                            <option value="preparing">قيد التحضير</option>
                            <option value="on_way">في الطريق</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-primary mt-4" onclick="loadOrders()">تحديث</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- جدول الطلبات المتأخرة -->
        <div class="card">
            <div class="card-header">
                <h3>الطلبات المتأخرة</h3>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped" id="ordersTable">
                        <thead>
                            <tr>
                                <th>رقم الطلب</th>
                                <th>الفرع</th>
                                <th>الوكيل</th>
                                <th>التأخير (دقيقة)</th>
                                <th>العميل</th>
                                <th>الحالة</th>
                                <th>آخر تحديث</th>
                                <th>إجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- سيتم تحميل البيانات هنا -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- لوحة الأداء -->
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h3>أداء الفروع</h3>
                    </div>
                    <div class="card-body">
                        <canvas id="branchChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h3>أداء الوكلاء</h3>
                    </div>
                    <div class="card-body">
                        <canvas id="agentChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // تحميل الطلبات
        function loadOrders() {
            const outlet = document.getElementById('outlet').value;
            const agent = document.getElementById('agent').value;
            const status = document.getElementById('status').value;
            
            const url = `/api/delayed-orders?outlet=${outlet}&agent=${agent}&status=${status}`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    const tbody = document.querySelector('#ordersTable tbody');
                    tbody.innerHTML = '';
                    
                    data.forEach(order => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${order.order_no}</td>
                            <td>${order.outlet}</td>
                            <td>${order.agent_name}</td>
                            <td class="${order.delay_minutes > 30 ? 'delay-high' : order.delay_minutes > 15 ? 'delay-medium' : 'delay-low'}">
                                ${order.delay_minutes}
                            </td>
                            <td>${order.cus_name}</td>
                            <td>${order.status}</td>
                            <td>${new Date(order.last_updated).toLocaleString('ar-SA')}</td>
                            <td>
                                <button class="btn btn-sm btn-success" onclick="updateOrder(${order.id})">تحديث</button>
                                <button class="btn btn-sm btn-warning" onclick="contactCustomer(${order.id})">اتصال</button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                });
        }
        
        // تحديث حالة الطلب
        function updateOrder(orderId) {
            const newStatus = prompt('أدخل الحالة الجديدة (preparing/on_way/delivered):');
            if (newStatus) {
                fetch(`/api/update-order/${orderId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                })
                .then(response => response.json())
                .then(() => loadOrders());
            }
        }
        
        // الاتصال بالعميل
        function contactCustomer(orderId) {
            fetch(`/api/contact-customer/${orderId}`, { method: 'POST' })
                .then(response => response.json())
                .then(data => alert(data.message));
        }
        
        // تحميل بيانات الأداء
        function loadPerformance() {
            // بيانات الفروع
            fetch('/api/branch-performance')
                .then(response => response.json())
                .then(data => {
                    const ctx = document.getElementById('branchChart').getContext('2d');
                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: data.map(b => b.outlet_name),
                            datasets: [{
                                label: 'متوسط وقت التوصيل',
                                data: data.map(b => b.avg_delivery_time),
                                backgroundColor: 'rgba(54, 162, 235, 0.5)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: { responsive: true }
                    });
                });
            
            // بيانات الوكلاء
            fetch('/api/agent-performance')
                .then(response => response.json())
                .then(data => {
                    const ctx = document.getElementById('agentChart').getContext('2d');
                    new Chart(ctx, {
                        type: 'radar',
                        data: {
                            labels: data.map(a => a.agent_name),
                            datasets: [{
                                label: 'نسبة الأداء',
                                data: data.map(a => a.performance_score),
                                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                borderColor: 'rgba(255, 99, 132, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: { responsive: true }
                    });
                });
        }
        
        // تحميل البيانات عند فتح الصفحة
        window.onload = () => {
            loadOrders();
            loadPerformance();
            
            // تحديث تلقائي كل 30 ثانية
            setInterval(loadOrders, 30000);
        };
    </script>
</body>
</html>
'''

# تشغيل التطبيق
if __name__ == '__main__':
    init_db()
    app.run(debug=True, host='0.0.0.0', port=5000)
